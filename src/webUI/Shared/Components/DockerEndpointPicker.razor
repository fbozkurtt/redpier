@inject HttpClient Client
@inject ILocalStorageService LocalStorage
@inject IToastService ToastService;

@if (!IsForMobile)
{
    <ul class="dropdown-menu" aria-labelledby="dockerEndpointPicker">
        @if (Endpoints != null)
        {
            @foreach (var endpoint in Endpoints.Items)
            {
                <li>
                    <a class="dropdown-item text-truncate" style="cursor: pointer" @onclick="e => SelectEndpoint(endpoint)">
                        <span class="fa fa-circle"
                              style="color: @(SelectedEndpoint.Status.Equals(Status.Online) ? "limegreen" : "orangered")" 
                              hidden="@(!SelectedEndpoint.Id.Equals(endpoint.Id))">
                        </span>
                        <span>@endpoint.Name</span>
                        <span class="@(SelectedEndpoint.Id.Equals(endpoint.Id) ? "fa fa-check" : "")"></span>
                    </a>
                </li>
            }
        }
        else
        {
            <li>
                <div class="text-center dropdown-item">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </li>
        }
    </ul>
}
else
{
    <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" id="dockerEndpointPicker" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Docker endpoint
        </a>
        <div class="dropdown-menu dropdown-menu-nav" aria-labelledby="dockerEndpointPicker">
            <a class="dropdown-item">
                local<span class="fa fa-check pl-2"></span>
            </a>
            <a class="dropdown-item">local_windows</a>
        </div>
    </li>
}

@code{
    [Parameter]
    public bool IsForMobile { get; set; } = false;

    [Inject]
    public IEndpointService EndpointService { get; set; }

    public PaginatedListViewModel<Endpoint> Endpoints;

    public Endpoint SelectedEndpoint { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await FetchData();
    }

    public async Task FetchData()
    {

        try
        {
            Endpoints = await EndpointService.GetEndpointsAsync();

            var savedEndpoint = await EndpointService.GetSelectedEndpointAsync();
            if (savedEndpoint != default && Endpoints.Items.ToList().Contains(savedEndpoint))
            {
                SelectedEndpoint = savedEndpoint;
            }
            else
            {
                await SelectEndpoint(Endpoints.Items.First());
            }
            if (await EndpointService.PingAsync())
                SelectedEndpoint.Status = Status.Online;
        }
        catch (Exception ex)
        {
            ToastService.ShowError(ex.Message);
        }
    }

    public async Task SelectEndpoint(Endpoint endpoint)
    {
        await EndpointService.SetSelectedEndpointAsync(endpoint);
        SelectedEndpoint = endpoint;
    }
}
